---
include: /.gitlab/templates.yaml

.magento-image:
  extends: .common-build
  needs: ["php:build"]
  before_script:
    - mkdir -p "/kaniko/.composer/" && cp "$CI_COMPOSER_AUTH" "/kaniko/.composer/auth.json"
  script:
    - /kaniko/executor
      --context $CI_PROJECT_DIR/magento
      --dockerfile $CI_PROJECT_DIR/magento/Base.Dockerfile
      --destination "$CI_REGISTRY_IMAGE/magento-${MAGENTO_EDITION}:${MAGENTO_VERSION}-${CI_COMMIT_TAG}"
      --build-arg BASE_IMAGE="$CI_REGISTRY_IMAGE/php:${PHP_VERSION}"
      --build-arg MAGENTO_VERSION="$MAGENTO_VERSION"
      --build-arg MAGENTO_EDITION="$MAGENTO_EDITION"
      --single-snapshot
      --cleanup

magento:ce:build:
  extends: .magento-image
  variables:
    MAGENTO_EDITION: community

magento:ee:build:
  extends: .magento-image
  variables:
    MAGENTO_EDITION: enterprise

magento:ce:publish:
  extends: .publish
  variables:
    MAGENTO_EDITION: community
    ORGINAL_IMAGE: "magento-${MAGENTO_EDITION}:${MAGENTO_VERSION}-${CI_COMMIT_TAG}"
    TARGET_IMAGE: "$MAGENTO_EDITION"
  needs: ['magento:ce:build']

magento:ee:publish:
  extends: .publish
  variables:
    MAGENTO_EDITION: enterprise
    ORGINAL_IMAGE: "magento-${MAGENTO_EDITION}:${MAGENTO_VERSION}-${CI_COMMIT_TAG}"
    TARGET_IMAGE: "$MAGENTO_EDITION"
  needs: ['magento:ee:build']
